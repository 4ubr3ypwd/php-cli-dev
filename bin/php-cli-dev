#!/usr/bin/env php
<?php

namespace aubreypwd\PHP_CLI_Dev;

use \splitbrain\phpcli\Options;

require_once __DIR__ . '/../autoload.php';

final class Command extends \aubreypwd\PHP_CLI\CLI {

	protected function setup( Options $options ) : void {

		$this->set_desc( $options, 'Development testbed for aubreypwd/php-cli.' );

		$this->explain_option( $options, 'version', 'Print version.', 'v' );
		$this->explain_option( $options, 'do', 'This should require an argument.', 'd', 'all' );

		$this->explain_argument( $options, 'all', 'Test the all methods.', false );
	}

	protected function main( Options $options ) : void {

		$this->lb();
		$this->log( '<yellow>Welcome</yellow> <green>to</green> <red>php-cli-dev</red>.' );
		$this->lb();

		if ( in_array( true, [
			$this->do_all( $options ),
			$this->method_tests( $options ),
			$this->version( $options ),
		], true ) ) {
			return;
		}

		$this->show_help( $options );
	}

	private function do_all( Options $options ) : bool {

		$opt_value = $this->get_opt( $options, 'do' );

		if ( empty( $opt_value ) ) {
			return false;
		}

		$this->info( "--do is set to: {$opt_value}" );

		return true;
	}

	private function version( Options $options ) : bool {

		if ( ! $this->get_opt( $options, 'version' ) ) {
			return false;
		}

		$this->info( '1.0.0' );

		return true;
	}

	private function method_tests( Options $options ) : bool {

		return in_array( true, [

			$this->test_method( $options, 'has_command', function() {
				$this->info( $this->has_command( 'brew' ) ? 'brew is installed' : 'brew not installed' ); $this->info( $this->has_command( 'asdfqwer01234' ) ? 'asdfqwer01234 is installed' : 'asdfqwer01234 not installed' );
			} ),

			$this->test_method( $options, 'get_php_version', function() {
				$this->info( "The PHP version installed is: {$this->get_php_version()}" );
			} ),

			$this->test_method( $options, 'get_working_dirname', function() {
				$this->info( "The current directory name is: {$this->get_working_dirname()}" );
			} ),

			$this->test_method( $options, 'get_working_dir', function() {
				$this->info( "The current directory path is: {$this->get_working_dir()}" );
			} ),
		], true );
	}

	private function test_method( Options $options, string $arg, $cb ) {

		$this->explain_argument( $options, $arg, "Test the {$arg}() method.", false );

		if (
			! $this->arg_present( $options, $arg ) && // By name
			'all' !== $this->get_arg( $options, 0 ) && // all
			'all' !== $this->get_opt( $options, 'do' ) // --do all
		) {
			return false;
		}

		$cb();

		return true;
	}
}

$cli = new \aubreypwd\PHP_CLI_Dev\Command();

try {

	$cli->run();

} catch ( \Exception $e ) {

	$cli->log( 'error', "{$e->getMessage()}\n" );
}
